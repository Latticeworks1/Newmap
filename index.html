<!DOCTYPE html>
<html>

<head>
    <title>HydroMatic-Ground Water Contour Mappere</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
/* Base Styles */
:root {
    --background-color: #222;
    --text-color: #fff;
    --primary-color: #007BFF;
    --secondary-color: #0056b3;
    --navbar-background: #333;
    --button-background: #444;
}

/* Global Styles */
body, button, input, select {
    font-family: 'Roboto', sans-serif;
    font-size: 16px;
    margin: 0;
    padding: 0;
    background-color: var(--background-color);
    color: var(--text-color);
}

/* Accessibility */
[role="button"], [role="menuitem"] {
    cursor: pointer;
}

/* Navbar Styles */
#navbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: var(--navbar-background);
    color: var(--text-color);
    padding: 16px 32px;
    width: 100%;
}

#navbar .nav-logo {
    cursor: pointer;
    flex-grow: 1;
}

#navbar .nav-links {
    list-style: none;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: auto;
}

#navbar .nav-links li {
    margin: 0 8px;
}

#navbar .nav-links a {
    color: var(--text-color);
    text-decoration: none;
    font-size: 18px;
    padding: 8px 16px;
}

#navbar .menu-toggle {
    display: none;
}

#navbar .bar {
    background-color: var(--text-color);
    margin: 3px 0;
    width: 25px;
    height: 3px;
}

/* Responsive Design for Mobile */
@media screen and (max-width: 768px) {
    #navbar {
        flex-direction: column;
        text-align: center;
    }

    #navbar .nav-links {
        margin-left: 0;
        margin-top: 16px;
    }

    #navbar .menu-toggle {
        display: block;
        margin-top: 16px;
    }
}
/* Styles for Popup Input Fields */
.popup-input {
    width: 100%;
    padding: 5px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 14px;
}

/* Styles for Popup Buttons */
.popup-button,
#signInButton,
#openSignUp,
#signUpButton {
    background-color: var(--primary-color);
    color: var(--text-color);
    border: none;
    padding: 8px 16px;
    margin: 5px 0;
    width: auto;
    border-radius: 3px;
    cursor: pointer;
    font-size: 16px;
}

/* Style for Modal Input Fields and Buttons */
.modal-input-button {
    margin-bottom: 10px;
}

/* If you want to have a different margin for the last item to reduce the space above the buttons */
.modal-body > :last-child {
    margin-bottom: 0;
}

/* Styles for Popup Buttons on Hover */
.popup-button:hover,
#signInButton:hover,
#openSignUp:hover,
#signUpButton:hover {
    background-color: var(--secondary-color);
}

/* Style for the "Show Contour Plot" Button */
#showContourPlotBtn {
    background-color: var(--primary-color);
    color: var(--text-color);
    padding: 8px 16px;
}

/* Style for the "Show Contour Plot" Button on Hover */
.show-contour-plot-button:hover {
    background-color: var(--secondary-color);
}

/* Updated Style for the Map Layer Toggle Switch */
.switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 30px;
    margin-right: 10px;
    vertical-align: middle;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 2px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-color);
}

input:checked + .slider:before {
    transform: translateX(30px);
}

/* Style for the Label Next to the Toggle Switch */
.toggle-label {
    display: inline-block;
    color: var(--text-color);
    font-size: 16px;
    vertical-align: middle;
}

/* Sidebar Styles */
#sidebar {
    display: flex;
    flex-direction: column;
    background-color: #333;
    color: #fff;
    padding: 16px;
    text-align: center;
    min-width: 250px;
    transition: width 0.3s;
    margin: 3vh 10px; /* Updated margin to create space around the sidebar */
}

/* Input Controls Section Styles */
#inputControls {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 16px;
    height: 80vh;
    width: 250px;
    margin: 3vh 1px 0 1px;
    background-color: #333;
}

#inputControls button,
#inputControls input,
#inputControls select {
    background-color: var(--button-background);
    color: #fff;
    border: none;
    padding: 8px 16px;
    margin: 3vh 0;
    width: 100%;
}

/* Left Side Container Styles */
#left-side {
    flex-direction: column;
    align-items: flex-start;
}

/* Main Application Container Styles */
#app-container {
    display: flex;
    align-items: stretch;
 margin: 0 0px 0 10px; /* Updated margin to create space on the right side */
    min-height: 100vh;
    overflow-y: scroll;
}

/* Map Area Styles */
#map {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    flex: 2;
    margin: 0 10px 0 0; /* Updated margin to create space on the right side */
    width: calc(80vw - 10px); /* Adjusted width to account for the margin */
    height: 60vh;
}

/* Table for Markers Styles */
#markerTable {
    border-collapse: collapse;
    width: calc(20vw - 10px); /* Adjusted width to account for the margin */
    max-height: 60vh; /* Match the height to the map */
    width: 80vw; /* Match the width to the map */
    overflow-y: auto;
    margin: 0 10px 0 10px; /* Updated margin to create space on the left side */
}

#markerTable thead {
    background-color: #f2f2f2;
}

#markerTable thead th {
    padding: 16px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

#markerTable tbody td {
    text-align: left;
    color: #fff;
    overflow-y: auto;
}

/* General Modal Styles */
.modal,
.modal1 {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 50%;
    top: 50%;
    pointer-events: auto;
    transform: translate(-50%, -50%);
}

/* Specific Modal Background Colors */
.modal {
    background-color: transparent;
}

.modal1 {
    background-color: grey;
}

/* Modal Content Styles */
.modal-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: #2c2c2c;
    color: #fff;
    padding: 16px;
    border: 1px solid #444;
    width: 35vw;
    height: 45vh;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
    position: relative;
}

/* Modal Header Styles */
.modal-header {
    max-width: 80%;
    cursor: move;
    padding: 16px;
    background-color: #333;
    color: #fff;
    text-align: center;
    font-size: 1.5rem;
    margin-bottom: 16px;
}

/* Modal Body Styles */
.modal-body {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
}

/* Other Modal Elements Styles */
.modal-open,
.close {
    pointer-events: auto;
}

.close {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 24px;
    color: #fff;
    cursor: pointer;
}

/* Updated Modal Body Styles */
.modal-body {
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 80%;
    padding: 10px;
}

@media screen and (max-width: 600px) {
    .modal-content {
        width: 90%;
        height: 90%;
    }
}
/* Existing Sidebar Elements Styles */
#projectList,
#inputControls input,
#inputControls button,
#inputControls select {
    width: 100%;
    margin-top: 10px;
}

/* Splash Overlay Styles */
#splash-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

/* Keyframes for the fadeIn Animation */
@keyframes fadeIn {
    0% {
        opacity: 0;
    }
    100% {
        opacity: 1;
    }
}

/* Prevent Text Selection for Some Elements */
.noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Style for the "Add Marker" Button */
.add-marker-button {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    margin: 5px 0;
    width: 100%;
    border-radius: 3px;
    cursor: pointer;
    font-size: 16px;
}

/* Style for the "Add Marker" Button on Hover */
.add-marker-button:hover {
    background-color: #218838;
}

/* Contour Plot Modal Styles */
#contourPlotModal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: grey;
    border: 1px solid #444;
    width: 35vw;
    height: 45vh;
    box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
    pointer-events: auto;
    overflow: hidden;
}

#contourPlotContainer {
    width: 100%;
    height: 100%;
    background-color: #2c2c2c;
    overflow: hidden;
}

/* Add this style to set the colorscale text to white */
.colorbar-title-text {
    fill: white !important;
}
    </style>
</head>
    <!-- Splash Overlay -->
    <div id="splash-overlay">
        <img src="https://github.com/Latticeworks1/Hydro-Matic/blob/main/splash.png?raw=true" alt="Splash Image">
    </div>

    <!-- Navigation -->
    <nav id="navbar">
        <div class="nav-logo">
            <img src="https://github.com/Latticeworks1/Hydro-Matic/blob/main/hydromaticlogo_inverted.png?raw=true" alt="Company Logo" style="height:40px;">
        </div>
        <ul class="nav-links">
            <li>
                <button id="showContourPlotBtn" class="show-contour-plot-button">Show Contour Plot</button>
            </li>
            <li><a href="#">Home</a></li>
            <li><a href="#">About</a></li>
            <li><a href="#">Contact</a></li>
            <li>
                <button id="authBtn">Sign-in/up</button>
            <input type="file" id="uploadProjectFile" accept=".json" class="hide">
            </li>
        </ul>
        <div class="menu-toggle" id="mobile-menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </div>
    </nav>
</head>

<body>
    <div id="app-container">
        <!-- Sidebar -->
        <aside>
            <div id="inputControls">
                <!-- User Info Section -->
                <div id="userInfo" style="display: none;">
                    <p>Welcome, <span id="usernameDisplay"></span>!</p>
                </div>
                <!-- Feedback Container -->
                <div id="feedbackContainer" style="display: none;">
                    <p id="feedbackMessage"></p>
                </div>

                <!-- Buttons -->
                <button id="createProjectBtn">Create New Project</button>
                <button id="loadMapDataBtn">Load Data</button>
                <button id="exportMapDataBtn">Save Map</button>

                <!-- Modals -->
                <div id="contourPlotModal" class="modal">
                    <div class="modal-content" id="draggableModal">
                        <span class="close" id="closeContourPlot">&times;</span>
                        <div id="contourPlotContainer">
                            <div id="contourPlot"></div>
                        </div>
                    </div>
                </div>

                <div id="scatter3DPlotModal" class="modal">
                    <div class="modal-content">
                        <span class="close" id="closeScatter3DPlot">&times;</span>
                        <div id="scatter3DPlot"></div>
                    </div>
                </div>

                <!-- Project Controls -->
                <label for="projectList">Project List:</label>
                <select id="projectList"></select>
                <label for="projectNumberInput">Project Number:</label>
                <input type="text" id="projectNumberInput" placeholder="Project Number">
                <label for="projectNameInput">Project Name:</label>
                <input type="text" id="projectNameInput" placeholder="Project Name">
                <label for="mapNameInput">Map ID:</label>
                <input type="text" id="mapNameInput" placeholder="Map ID">
            </div>
        </aside>

        <!-- Main Content -->
        <main id="left-side">
            <div id="map"></div>
            <table id="markerTable" class="table table-striped">
                <thead>
                    <tr>
                        <th>Well ID</th>
                        <th>Elevation</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </main>

        <!-- Right Side Content -->
        <div id="right-side" class="flex-item">
            <!-- Add your content here -->
        </div>
    </div>
</body>

</html>

<!-- Sign-in Modal -->
<div id="signInModal" class="modal1 noselect">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" id="closeSignIn">&times;</span>
            <h2>Sign In</h2>
        </div>
        <div class="modal-body">
            <label for="signInUsername">Username:</label>
            <input type="text" id="signInUsername" placeholder="Enter your username">
            <p id="signInError" style="color:red;"></p>
            <label for="signInPassword">Password:</label>
            <input type="password" id="signInPassword" placeholder="Enter your password">
            <button id="signInButton">Sign In</button>
            <button id="openSignUp">Sign Up</button>
        </div>
    </div>
</div>

<!-- Sign-up Modal -->
<div id="signUpModal" class="modal1 noselect">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close" id="closeSignUp">&times;</span>
            <h2>Sign Up</h2>
        </div>
        <div class="modal-body">
            <label for="signUpUsername">Username:</label>
            <input type="text" id="signUpUsername" placeholder="Choose a username">
            <p id="signUpError" style="color:red;"></p>
            <label for="signUpPassword">Password:</label>
            <input type="password" id="signUpPassword" placeholder="Choose a password">
            <button id="signUpButton">Sign Up</button>
        </div>
    </div>
</div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
class Authentication {
    async sendRequest(action, username, password) {
        try {
            const response = await fetch('https://neftyartstudio.com/auth_master.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `action=${action}&username=${username}&password=${password}`
            });
            return await response.json();
        } catch (error) {
            return { status: 'error', message: 'Error connecting to the server.' };
        }
    }

    displayFeedback(message, type, feedbackMessage, feedbackContainer) {
        if (type === 'signIn') {
            document.getElementById("signInError").textContent = message;
        } else if (type === 'signUp') {
            document.getElementById("signUpError").textContent = message;
        } else {
            feedbackMessage.textContent = message;
            feedbackContainer.style.display = "block";
            setTimeout(() => {
                feedbackContainer.style.display = "none";
                feedbackMessage.textContent = "";
            }, 5000);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    const auth = new Authentication();
    const signInModal = document.getElementById("signInModal");
    const signUpModal = document.getElementById("signUpModal");
    const signInUsername = document.getElementById("signInUsername");
    const signInPassword = document.getElementById("signInPassword");
    const signUpUsername = document.getElementById("signUpUsername");
    const signUpPassword = document.getElementById("signUpPassword");
    const feedbackContainer = document.getElementById("feedbackContainer");
    const feedbackMessage = document.getElementById("feedbackMessage");

    // Check if the user is already logged in
    const loggedInUser = localStorage.getItem('loggedInUser');
    if (loggedInUser) {
        document.getElementById("userInfo").style.display = "block"; // Display the user info section
        document.getElementById("usernameDisplay").textContent = loggedInUser; // Update the username display
    }

localStorage.setItem('loggedInUser', signInUsername.value); // for login
localStorage.setItem('loggedInUser', signUpUsername.value); // for sign-up
localStorage.removeItem('loggedInUser');
    // Function to send requests to the PHP endpoint
    async function sendRequest(action, username, password) {
        try {
            const response = await fetch('https://neftyartstudio.com/auth_master.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `action=${action}&username=${username}&password=${password}`
            });
            return await response.json();
        } catch (error) {
            return { status: 'error', message: 'Error connecting to the server.' };
        }
    }

    function displayFeedback(message, type) {
        if (type === 'signIn') {
            document.getElementById("signInError").textContent = message;
        } else if (type === 'signUp') {
            document.getElementById("signUpError").textContent = message;
        } else {
            feedbackMessage.textContent = message;
            feedbackContainer.style.display = "block";
            setTimeout(() => {
                feedbackContainer.style.display = "none";
                feedbackMessage.textContent = "";
            }, 5000);
        }
    }
 document.getElementById("signInButton").addEventListener("click", async () => {
     const response = await auth.sendRequest('login', signInUsername.value, signInPassword.value);
        auth.displayFeedback(response.message, response.status === 'success' ? null : 'signIn', feedbackMessage, feedbackContainer);
    if (response.status === 'success') {
        signInModal.style.display = "none";
        document.getElementById("userInfo").style.display = "block"; // Display the user info section
        document.getElementById("usernameDisplay").textContent = signInUsername.value; // Update the username display
    }
});
document.getElementById("signUpButton").addEventListener("click", async () => {
    if (signUpUsername.value.trim() === "" || signUpPassword.value.trim() === "") {
        displayFeedback("Please enter a valid username and password.", 'signUp');
        return;
    }
    const response = await auth.sendRequest('register', signUpUsername.value, signUpPassword.value);
        auth.displayFeedback(response.message, response.status === 'success' ? null : 'signUp', feedbackMessage, feedbackContainer);
 if (response.status === 'success') {
            signUpModal.style.display = "none";
            document.getElementById("userInfo").style.display = "block";
            document.getElementById("usernameDisplay").textContent = signUpUsername.value;
            localStorage.setItem('loggedInUser', signUpUsername.value); // Store the username in local storage
        }
    });
    document.getElementById("authBtn").addEventListener("click", () => { signInModal.style.display = "block"; });
    document.getElementById("openSignUp").addEventListener("click", () => {
        signInModal.style.display = "none";
        signUpModal.style.display = "block";
    });
    document.getElementById("closeSignIn").addEventListener("click", () => { signInModal.style.display = "none"; });
    document.getElementById("closeSignUp").addEventListener("click", () => { signUpModal.style.display = "none"; });
});
    // Draggable functionality
    function makeDraggable(modal) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        const header = modal.querySelector('.modal-header'); // Only the header is draggable

        header.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            let newTop = modal.offsetTop - pos2;
            let newLeft = modal.offsetLeft - pos1;
            newTop = Math.max(newTop, 0);
            newTop = Math.min(newTop, window.innerHeight - modal.offsetHeight);
            newLeft = Math.max(newLeft, 0);
            newLeft = Math.min(newLeft, window.innerWidth - modal.offsetWidth);
            modal.style.top = newTop + "px";
            modal.style.left = newLeft + "px";
        }
    }



    makeDraggable(signInModal);
    makeDraggable(signUpModal);



  // Function to hide the splash overlay after a delay or when the page is fully loaded
setTimeout(function () {
    var splashOverlay = document.getElementById("splash-overlay");
    if (splashOverlay) {
        splashOverlay.style.opacity = "0";
        setTimeout(function(){
            splashOverlay.style.display = "none";
        }, 750);  // Match the duration of the fade-out with the one specified in CSS
    }
}, 1000);  // 3000 milliseconds = 3 seconds

function exportMapData() {
    console.log("Export button clicked");  // Debugging line

    // Get project details
    const projectNumber = document.getElementById("projectNumberInput").value;
    const projectName = document.getElementById("projectNameInput").value;
    const mapName = document.getElementById("mapNameInput").value;

    // Combine project details with marker data
    const exportData = {
        projectNumber: projectNumber,
        projectName: projectName,
        mapName: mapName,
        markerData: markerData // Assuming markerData is your existing array
    };

    // Check if marker data is available
    if (markerData && markerData.length > 0) {
        // Create a Blob with the combined data as JSON
        const blob = new Blob([JSON.stringify(exportData)], { type: 'application/json' });

        // Create a download link
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${projectNumber}_${mapName}.json`;

        // Trigger a click event to download the file
        a.click();
    } else {
        console.log("markerData is empty or not initialized");
    }
}
        // Declare global variables for map, markers, and modal state
        let map;
        let markerData = [];
        let markers = [];
        let modalOpen = false;

        // Initialize application after window load
        window.addEventListener("load", initialize);

        /**
         * Main Initialization Function
         */
        function initialize() {
            // Initialize map and load markers
            map = initializeMap();
            markerData = loadMarkersFromLocalStorage();
            markers = [];

            // Add existing markers to map
            markerData.forEach(coord => addMarker(coord));
    // Attach the event listener for the export button
    document.getElementById("exportMapDataBtn").addEventListener("click", exportMapData);

            // Attach event handlers
            map.on('click', handleMapClick);
            document.getElementById("showContourPlotBtn").addEventListener("click", showContourPlot);
            document.getElementById("closeContourPlot").addEventListener("click", hideContourPlot);
            
            // Make contour plot modal draggable
            dragElement(document.getElementById("draggableModal"));

            // Listen to map zoom and move events to update contour plot
            map.on('moveend zoomend', function() {
                if (modalOpen) {
                    drawContourPlot();
                }
            });
            
            // Initialize the table with marker data
            updateTable();
        }

        /**
         * Initialize the Leaflet map.
         * @returns {object} Initialized map object.
         */
function initializeMap() {
    // Initialize Leaflet map and set view
    const map = L.map('map').setView([51.505, -0.09], 13);

    // Define the tile layers for the street map and Esri satellite imagery
    const streetMapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriSatelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });

    // Create an object with the available tile layers
    const baseLayers = {
        "Street Map": streetMapLayer,
        "Esri Satellite": esriSatelliteLayer
    };

    // Add the Esri satellite layer as the default layer
    esriSatelliteLayer.addTo(map);

    // Add a layer control to the map, allowing users to switch between layers
    L.control.layers(baseLayers).addTo(map);



    return map;
}

/**
 * Handle click events on the map to add new markers.
 * @param {Event} e - Leaflet click event object.
 */
function handleMapClick(e) {
    const wellIDInput = document.createElement("input");
    wellIDInput.type = "text";
    wellIDInput.placeholder = "Enter Well ID";
    wellIDInput.className = "popup-input"; // Add a class for styling

    const elevationInput = document.createElement("input");
    elevationInput.type = "number";
    elevationInput.placeholder = "Enter Elevation";
    elevationInput.className = "popup-input"; // Add a class for styling

    const addButton = document.createElement("button");
    addButton.textContent = "Add Marker";
addButton.className = "add-marker-button"; // Use the new class for styling
    addButton.addEventListener("click", () => {
        const wellID = wellIDInput.value.trim();
        const elevation = parseFloat(elevationInput.value.trim());

        if (wellID === "") {
            alert("Please enter a Well ID.");
            return;
        }

        // Process coordinates and add marker with Well ID and elevation
        const coord = { lat: e.latlng.lat, lng: e.latlng.lng, elevation: elevation, wellID: wellID };
        addMarker(coord);
        markerData.push(coord);
        saveMarkersToLocalStorage();
        updateTable();
    });

    // Create a popup with input fields for Well ID and elevation
    const popupContent = document.createElement("div");
    popupContent.appendChild(wellIDInput);
    popupContent.appendChild(elevationInput);
    popupContent.appendChild(addButton);

    L.popup()
        .setLatLng(e.latlng)
        .setContent(popupContent)
        .openOn(map);
}
// Function to add a new marker to the map
function addMarker(coord) {
    // Create a custom popup content with the new format
    const popupContent = document.createElement("div");
    popupContent.innerHTML = `
        <p><strong>Well ID:</strong> ${coord.wellID}</p>
        <p><strong>Coordinates:</strong> ${coord.lat}, ${coord.lng}</p>
        <p><strong>Elevation:</strong> ${coord.elevation}</p>
    `;

    // Create and add marker to the map with the custom popup content
    const marker = L.marker([coord.lat, coord.lng])
        .addTo(map)
        .bindPopup(popupContent)
        .openPopup();

    // Add right-click event listener to remove marker
    marker.on('contextmenu', function (e) {
        const index = markers.indexOf(this);
        removeMarker(index);
    });

    // Add marker to the global markers array
    markers.push(marker);
}
// Function to load markers data from local storage
function loadMarkersFromLocalStorage() {
    // Fetch saved markers from local storage and parse the JSON data
    const savedData = localStorage.getItem("markerData");
    return savedData ? JSON.parse(savedData) : [];
}

// Function to save current markers data to local storage
function saveMarkersToLocalStorage() {
    // Convert markers data to JSON and save to local storage
    localStorage.setItem("markerData", JSON.stringify(markerData));
}
// Event listener for the "Load Map Data" button
document.getElementById("loadMapDataBtn").addEventListener("click", () => {
    // Trigger the file input click event when the "Load Data" button is clicked
    document.getElementById("uploadProjectFile").click();
});

// Event listener for the file input change event
document.getElementById("uploadProjectFile").addEventListener("change", (event) => {
    const file = event.target.files[0]; // Get the selected file

    if (!file) {
        console.log("No file selected.");
        return;
    }

    const reader = new FileReader();

    reader.onload = function (e) {
        try {
            const projectDataFromFile = JSON.parse(e.target.result);

            if (projectDataFromFile && projectDataFromFile.markerData) {
                // Clear existing markers on the map
                clearMapMarkers();

                // Load markers from the projectDataFromFile
                markerData = projectDataFromFile.markerData;

                // Add loaded markers to the map
                markerData.forEach(coord => addMarker(coord));

                // Update the table with the loaded marker data
                updateTable();

                // Optionally, perform other actions based on the loaded project data
            } else {
                console.log("Invalid project data.");
            }
        } catch (error) {
            console.error("Error parsing project data:", error);
        }
    };

    reader.readAsText(file);
});

function updateTable() {
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = "";

    markerData.forEach((coord, index) => {
        const row = tableBody.insertRow();
        const wellIDCell = row.insertCell(0); // Add a cell for Well ID
        const elevCell = row.insertCell(1);
        const latCell = row.insertCell(2);
        const lngCell = row.insertCell(3);
        wellIDCell.innerHTML = `<input type="text" id="wellIDInput${index}" value="${coord.wellID}" onchange="updateWellID(${index}, this.value)">`; // Input field for Well ID
        const actionCell = row.insertCell(4); // Adjust the index for the action cell

        latCell.textContent = coord.lat;
        lngCell.textContent = coord.lng;

        const elevationInput = document.createElement("input");
        elevationInput.type = "number";
        elevationInput.value = coord.elevation;
        elevationInput.addEventListener("change", function () {
            coord.elevation = parseFloat(this.value);
            saveMarkersToLocalStorage();
            markers[index].bindPopup(`Coordinates: ${coord.lat}, ${coord.lng}, Elevation: ${coord.elevation}, Well ID: ${coord.wellID}`).openPopup();
            drawContourPlot(); // Redraw the contour plot on elevation change
        });
        elevCell.appendChild(elevationInput);

        const removeButton = document.createElement("button");
        removeButton.textContent = "Remove";
        removeButton.addEventListener("click", () => removeMarker(index));
        actionCell.appendChild(removeButton);
    });
}

function updateWellID(index, newWellID) {
    markerData[index].wellID = newWellID;
    saveMarkersToLocalStorage();
    markers[index].bindPopup(`Coordinates: ${markerData[index].lat}, ${markerData[index].lng}, Elevation: ${markerData[index].elevation}, Well ID: ${newWellID}`).openPopup();
}

    function removeMarker(index) {
        const markerToRemove = markers[index];
        if (markerToRemove) {
            markerToRemove.remove();
        }

        markers.splice(index, 1);
        markerData.splice(index, 1);
        updateTable();
        saveMarkersToLocalStorage();
        drawContourPlot(); // Redraw the contour plot on marker removal
    }

// Function to show the modal
function showContourPlot() {
    const modal = document.getElementById("contourPlotModal");

    // Open the modal
    modal.style.display = "block";
    modalOpen = true;

    // Make the modal draggable
    dragElement(modal.querySelector('.modal-content'));

    // Redraw the contour plot when opening the modal
    drawContourPlot();
}

// Function to hide the modal
function hideContourPlot() {
    const modal = document.getElementById("contourPlotModal");

    // Close the modal
    modal.style.display = "none";
    modalOpen = false;
}
// Add an event listener to close the modal when the close button is clicked
document.getElementById("closeContourPlot").addEventListener("click", hideContourPlot);


// Make the DIV element draggable:
dragElement(document.getElementById("contourPlotModal"));  // Adjusted line

function dragElement(elmnt) {
  var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
  elmnt.onmousedown = dragMouseDown;

  function dragMouseDown(e) {
    e = e || window.event;
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
  }

  function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
  }
}
function drawContourPlot() {
    const latitudes = markerData.map(coord => coord.lat);
    const longitudes = markerData.map(coord => coord.lng);
    const elevations = markerData.map(coord => coord.elevation);

    const bounds = map.getBounds();
    
    const maxLat = bounds.getNorth();
    const minLat = bounds.getSouth();
    const maxLng = bounds.getEast();
    const minLng = bounds.getWest();

    // Create a scatter plot for the map markers
    const markerTrace = {
        x: longitudes,
        y: latitudes,
        mode: 'markers',
        type: 'scatter',
        marker: {
            size: 8,
            color: 'blue', // You can change the color as desired
            symbol: 'circle',
        },
        name: 'Markers'
    };


// Update the contourTrace to set the font color of the colorbar title to white
const contourTrace = {
    x: longitudes,
    y: latitudes,
    z: elevations,
    type: 'contour',
    colorscale: 'Viridis',
    zmin: Math.min(...elevations),
    zmax: Math.max(...elevations),
    colorbar: {
        title: {
            text: 'Elevation',
            font: {
                color: 'white' // Set the font color of the title to white
            }
        },
        tickfont: {
            color: 'white' // Set the font color of the numbers to white
        }
    },
    contours: {
        coloring: 'heatmap'
    },
    name: 'Elevation'
};
    const data = [markerTrace, contourTrace];

const layout = {
    xaxis: {
        title: 'Longitude',
        range: [minLng, maxLng],
        tickcolor: 'white',
        tickfont: {
            color: 'white',
        },
        titlefont: {
            color: 'white',
        },
        linecolor: 'white',
        gridcolor: 'white',
    },
    yaxis: {
        title: 'Latitude',
        range: [minLat, maxLat],
        tickcolor: 'white',
        tickfont: {
            color: 'white',
        },
        titlefont: {
            color: 'white',
        },
        linecolor: 'white',
        gridcolor: 'white',
    },
    autosize: false, // Disable autosizing
    width: 600, // Set the width to match the container's max width
    height: 400, // Set the height to match the container's max height
    margin: { t: 20, b: 60, l: 60, r: 20 }, // Add padding
    paper_bgcolor: 'rgba(0,0,0,0)', // Transparent background
    plot_bgcolor: 'rgba(0,0,0,0)', // Transparent background
};

    if (modalOpen) {
        Plotly.newPlot('contourPlot', data, layout);
    }
}
// Declare an array to store project data
let projectData = [];

// Function to create a new project
function createNewProject() {
    const projectNumber = document.getElementById("projectNumberInput").value;
    const projectName = document.getElementById("projectNameInput").value;
    const mapName = document.getElementById("mapNameInput").value;

    // Create a new project object
    const newProject = {
        projectNumber: projectNumber,
        projectName: projectName,
        mapName: mapName,
        mapData: [] // You can add map data associated with the project here
    };

    // Store the project data in an array
    projectData.push(newProject);

    // Store the project data in local storage
    localStorage.setItem("projectData", JSON.stringify(projectData));

    // Update the UI to display the list of projects
    updateProjectList();

    // Optionally, clear the input fields or perform other actions
    document.getElementById("projectNumberInput").value = "";
    document.getElementById("projectNameInput").value = "";
    document.getElementById("mapNameInput").value = "";
}

// Function to update the UI with the list of projects
function updateProjectList() {
    const projectList = document.getElementById("projectList");
    projectList.innerHTML = "";

    // Loop through the projectData array and create options for each project
    projectData.forEach((project, index) => {
        const option = document.createElement("option");
        option.value = index; // Use the index as a value or unique identifier
        option.textContent = project.projectName; // Display the project name
        projectList.appendChild(option);
    });
}

// Event listener for creating a new project
document.getElementById("createProjectBtn").addEventListener("click", createNewProject);

// Event listener for selecting a project
document.getElementById("projectList").addEventListener("change", loadProjectMapData);


// Function to load map data for the selected project
function loadProjectMapData() {
    const projectList = document.getElementById("projectList");
    const selectedProjectIndex = projectList.value;

    if (selectedProjectIndex !== "") {
        // Load the map data associated with the selected project
        const selectedProject = projectData[selectedProjectIndex];

        // Clear existing markers on the map
        clearMapMarkers();

        // Load markers from the selected project's mapData
        markerData = selectedProject.mapData;
        
        // Add loaded markers to the map
        markerData.forEach(coord => addMarker(coord));

        // Update the table with the loaded marker data
        updateTable();

        // Optionally, perform other actions or updates based on the loaded project data
    }
}

// Function to clear existing markers on the map
function clearMapMarkers() {
    markers.forEach(marker => {
        marker.remove();
    });
    markers = [];
}

// Event listener for selecting a project
document.getElementById("projectList").addEventListener("change", loadProjectMapData);

// Function to create a new project
function createNewProject() {
    const projectNumber = document.getElementById("projectNumberInput").value;
    const projectName = document.getElementById("projectNameInput").value;
    const mapName = document.getElementById("mapNameInput").value;

    // Create a new project object
    const newProject = {
        projectNumber: projectNumber,
        projectName: projectName,
        mapName: mapName,
        mapData: markerData // Assuming markerData is the map data for this project
    };

    // Store the project data in an array
    projectData.push(newProject);

    // Store the project data in local storage
    localStorage.setItem("projectData", JSON.stringify(projectData));

    // Update the UI to display the list of projects
    updateProjectList();

    // Optionally, clear the input fields or perform other actions
    document.getElementById("projectNumberInput").value = "";
    document.getElementById("projectNameInput").value = "";
    document.getElementById("mapNameInput").value = "";
}

// Event listener for creating a new project
document.getElementById("createProjectBtn").addEventListener("click", createNewProject);

// Function to update the UI with the list of projects
function updateProjectList() {
    const projectList = document.getElementById("projectList");
    projectList.innerHTML = "";

    // Loop through the projectData array and create options for each project
    projectData.forEach((project, index) => {
        const option = document.createElement("option");
        option.value = index; // Use the index as a value or unique identifier
        option.textContent = project.projectName; // Display the project name
        projectList.appendChild(option);
    });
}

// Add event listeners for the "Export Map Data" and "Load Map Data" buttons
document.getElementById("exportMapDataBtn").addEventListener("click", exportMapData);
document.getElementById("loadMapDataBtn").addEventListener("click", loadProjectFromFile);

// Function to load project data from a JSON file
function loadProjectFromFile() {
    const fileInput = document.getElementById("uploadProjectFile");
    const file = fileInput.files[0];

    if (!file) {
        console.log("No file selected.");
        return;
    }

    const reader = new FileReader();

    reader.onload = function (e) {
        try {
            const projectDataFromFile = JSON.parse(e.target.result);

            if (projectDataFromFile && projectDataFromFile.markerData) {
                // Clear existing markers on the map
                clearMapMarkers();

                // Load markers from the projectDataFromFile
                markerData = projectDataFromFile.markerData;

                // Add loaded markers to the map
                markerData.forEach(coord => addMarker(coord));

                // Update the table with the loaded marker data
                updateTable();

                // Optionally, perform other actions based on the loaded project data
            } else {
                console.log("Invalid project data.");
            }
        } catch (error) {
            console.error("Error parsing project data:", error);
        }
    };

    reader.readAsText(file);
}

// Initialize the projectData array from local storage if available
const storedProjectData = localStorage.getItem("projectData");
if (storedProjectData) {
    projectData = JSON.parse(storedProjectData);
    updateProjectList(); // Update the project list on page load
}

map.on('moveend', function() {
    // Fetch new bounds and redraw contour
    drawContourPlot();
});
</script>
</body>
</html>

